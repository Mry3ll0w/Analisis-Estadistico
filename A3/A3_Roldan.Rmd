---
title: "A3"
author: "Antonio Roldán Andrade"
date: "2025-12-15"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(corrplot)
```

## 1 Regresión Lineal 

### 1.1 Carga y preparación de los datos

```{r, echo=TRUE}

csv_location <- "salarios_INE_2022_sample.csv"
salariosDataSet <- read.csv(csv_location, sep = ",")

head(salariosDataSet,5)
salariosDataSet <- salariosDataSet %>%
 mutate(
  # 1. CONVERSIÓN Y ETIQUETADO DE VARIABLES CATEGÓRICAS SIMPLES

 
  SEXO = factor(SEXO,
         levels = c(1, 6), # 1=Hombre, 6=Mujer
         labels = c("Hombre", "Mujer")),

  # ESTU (Nivel de Estudios): Sobrescribe la columna 'ESTU'
  ESTU = factor(ESTU,
         levels = c(1, 2, 3, 4, 5, 6),
         labels = c("1. Sin Estudios/Primaria Incompleta",
              "2. Primaria Completa",
              "3. Secundaria 1ª Etapa (E.S.O.)",
              "4. Secundaria 2ª Etapa (Bachillerato)",
              "5. Formación Profesional",
              "6. Estudios Superiores")),

  # ANOS2 (Grupos de Edad): Sobrescribe la columna 'ANOS2'
  ANOS2 = factor(ANOS2,
         levels = c(1, 2, 3, 4, 5, 6),
         labels = c("1. Menos de 19",
               "2. 20 a 29",
               "3. 30 a 39",
               "4. 40 a 49",
               "5. 50 a 59",
               "6. 60 y más"
              )),


  # 2. RECODIFICACIÓN ESPECÍFICA DE CNACE (Actividad Económica)
 
  CNACE = case_when(
   # Nivel 1: B, C, D, E, F
   CNACE %in% c("B", "C", "D", "E", "F") ~ "1. Industria y Construcción",
   # Nivel 2: O, P, Q
   CNACE %in% c("O", "P", "Q") ~ "2. Servicios Públicos Clave",
   # Nivel 3: El resto
   TRUE ~ "3. Otros Servicios y Actividades"
  ),

  # Creamos la nueva variable
  CNACE_grp = factor(CNACE,
         levels = c("1. Industria y Construcción",
               "2. Servicios Públicos Clave",
               "3. Otros Servicios y Actividades")),


  # 3. RECODIFICACIÓN ESPECÍFICA DE CNO1 
 
  CNO1 = case_when(
   # Nivel 1: A0–C0 (Directores y Técnicos/Profesionales)
   substr(CNO1, 1, 1) %in% c("A", "B", "C") ~ "1. Dirección y Alta Cualificación",
   # Nivel 2: D0–J0 (Técnicos de Apoyo, Empleados, Servicios, Agricultores)
   substr(CNO1, 1, 1) %in% c("D", "E", "F", "G", "H", "I", "J") ~ "2. Cualificación Media",
   # Nivel 3: El resto (K0, L0, M0, N0, O0, P0, Q0)
   TRUE ~ "3. Baja Cualificación y Elementales"
  ),

  # Convertir CNO1 a factor y ordenar los niveles
  CNO1_grp = factor(CNO1,
         levels = c("1. Dirección y Alta Cualificación",
              "2. Cualificación Media",
              "3. Baja Cualificación y Elementales"))
 )



``` 



## 1.2 Estudio de correlación lineal

```{r, echo=TRUE}
# Extraemos todas las variables cuantitativas de la tabla
datos_cuantitativos <- salariosDataSet %>%
  select(where(is.numeric))

# Una vez tenemos los datos procedemos a realizar la matriz de correlacion
matriz_correlacion <- cor(datos_cuantitativos, use = "pairwise.complete.obs")
# 3. Visualizar la matriz
corrplot(matriz_correlacion, 
         method = "circle", # Puedes usar "square" o "number"
         type = "upper",    # Muestra solo la mitad superior
         tl.cex = 0.7,      # Tamaño de la fuente de las etiquetas
         tl.col = "black",  # Color de las etiquetas
         tl.srt = 45,       # Rotación de las etiquetas
         addCoef.col = "black", # Añade el número del coeficiente (opcional)
         number.cex = 0.6)      # Tamaño de los números (si los añades)
```
Como podemos apreciar la matriz es enorme, por lo que realizaremos un filtrado por elementos con una correlación alta (>= 0.7), con esto tendremos una mayor facilidad para obtener un resultado estudiable

```{r, echo=TRUE}

correlaciones_df <- as.data.frame(matriz_correlacion) %>%
  tibble::rownames_to_column("Var1") %>%
  # Nos vamos moviendo para tener una fila por cada par de correlación
  tidyr::pivot_longer(cols = -Var1, names_to = "Var2", values_to = "Correlacion") %>%
  
  # Aseguramos que no comparemos Var1 vs Var2 y Var2 vs Var1, y que no sea la diagonal (Var1 == Var2)
  filter(Var1 < Var2) %>%
  
  # Buscar correlaciones fuertes (|r| > 0.7)
  filter(abs(Correlacion) > 0.7) %>%
  
  # Ordenar por el valor absoluto de la correlación (de más fuerte a más débil)
  arrange(desc(abs(Correlacion)))

# Imprimir las correlaciones más fuertes
print("Pares de variables con correlación |r| > 0.7:")
print(correlaciones_df)

```

Podemos apreciar la existencia de múltiples variables con una fuerte correlación pudiendo destacar:  

- BASE <-> COTIZA: Como es lógico existe una fuerte correlación entre las contribuciones a la seguridad social y la base de cotización a la seguridad social, existe una correlación positiva entre ambas casi completa (0.953).

- JAP <-> JSP1: Cuanto mayor es la jornada laboral anual pactada mayor será la jornada semanal en la mayoría de los casos.

- IRPF <-> RETRINOIN: Consecuentemente, cuanto mayor es el salario bruto anual mayor será la cantidad de IRPF que tendrá que pagar el trabajador.


### 1.4. Generación de los conjuntos de entrenamiento y de test


```{r, echo=TRUE}
# Fijar la semilla para reproducibilidad
set.seed(42)

#`1. Crear el vector de índices para la muestra de entrenamiento (80%) ---

tamano_train <- floor(0.80 * nrow(salariosDataSet))

# seleccionamos los índices de las filas que irán a 'train'
indices_train <- sample(seq_len(nrow(salariosDataSet)), size = tamano_train)

# --- 2. Separar los conjuntos de datos ---

train <- salariosDataSet[indices_train, ]

test <- salariosDataSet[-indices_train, ]

print(paste("Tamaño total:", nrow(salariosDataSet)))
print(paste("Tamaño train (80%):", nrow(train)))
print(paste("Tamaño test (20%):", nrow(test)))

```

### 1.5. Estimación de modelos de regresión lineales simples con variable cualitativa

```{r, echo=TRUE}

# M1: RETRINOIN en función de SEXO
# Usamos Lm ya que estamos en un estudio de regresión lineal simple
modelo_sexo <- lm(RETRINOIN ~ SEXO, data = train)

# Mostrar el resumen del modelo 1
print("--- Resumen del Modelo 1: RETRINOIN ~ SEXO ---")
summary(modelo_sexo)

```
Como podemos apreciar en el resultado, tenemos:  
1) El salario medio estimado del grupo de referencia (hombre, b0) es de $31053.9$
2) La diferencia salarial media estimada de las mujeres respecto a los hombres es de $-6472.0$
3) El salario medio del grupo menos favorecido (mujeres) es:  
SalarioMujer = salario_medio_hombre + (coeficienteMujer) =31053.9 + (-6472.0) = 24581.9

Con respecto a la si estas estadísticas son significativas tenemos:  

Puesto que el p-valor del coeficiente es <2e-16, esto implica que dado que es un valor extremadamente pequeño y es mucho menor 
que el umbral de significación (alpha = 0.05) por tanto podemos rechazar la hipotesis nula (Ho: coeficiente es 0).

Por tanto podemos decir que la diferencia salarial media estimada de $-6472.0$ es estadísticamente significativa. 

Si nos centramos en la interpretación de R^2 tenemos:
El valor obtenido R-Squared es del 1.731 %, por lo que podemos decir la variable SEXO influye únicamente en el 1.73% de la variabilidad de la varianza pudiendo asumir que aún siendo la diferencia salarial es estadísticamente significativa, el modelo es débil desde el punto de vista predictivo. La mayor parte de la variación salarial ($\approx 98.27\%$) se debe a otros factores no incluidos en este modelo simple.




```{r, echo=TRUE}
modelo_pais <- lm(RETRINOIN ~ TIPOPAIS, data = train)

# Mostrar el resumen del modelo 1
print("--- Resumen del Modelo 2: RETRINOIN ~ PAIS ---")
summary(modelo_pais)

```

```{r, echo=TRUE}
print(mean(salariosDataSet$JAP[salariosDataSet$SEXO == "Mujer"]))
print(mean(salariosDataSet$JAP[salariosDataSet$SEXO == "Hombre"]))



```









