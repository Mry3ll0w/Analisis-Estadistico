---
title: "A1"
author: "Antonio Roldán Andrade"
date: "`r Sys.Date()`"
output: html_document
---

```{r, echo=FALSE,results='hide', include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(stringr)
library(skimr) 
library(ggplot2)
library(psych)
```

## Disclaimer
Este es el documento de resolución de la actividad 1 para la asignatura de 
Análisis Estadístico.

# 1. Estructura de los datos

## 1.1 Diccionario de los datos
En este apartado simplemente realizamos la carga de datos y una pequeña ordenacion.
```{r, echo=TRUE, include=FALSE}

# Cargamos en primer lugar el WorldSustainabilty
csv_location <- "WorldSustainabilityDataset.csv"
worldSustainabiltyDataSet <- read.csv(csv_location, sep = ",")

# Cargamos a continuación el DataDictonary
# Para cargar el dataset usamos la libreria readxl ==> install.packages("readxl")
# Realizamos la carga en la parte superior del código, limpieza

xlsx_location <- "Data_Dictionary.xlsx"
data_dictionaryDataSet <- read_excel(xlsx_location)


# Tabla 1 ==> ODS | Codigo Variable/Indicador | Descripcion

table1 <- data_dictionaryDataSet %>%
  select(`Associated SDG GOAL`, Code, Description)

# ODS | Descripcion
table2 <- data_dictionaryDataSet %>%
  select(`Associated SDG GOAL`, Description)

# Ordenamos y renombro por comodidad.
table1 <- table1 %>% arrange(`Associated SDG GOAL`)
table2 <- table2 %>% arrange(`Associated SDG GOAL`)

table1 <- table1 %>% rename( SDG = `Associated SDG GOAL`)
table2 <- table2 %>% rename( SDG = `Associated SDG GOAL`)
```
```{r}
head(table1,4)
head(table2,4)
```

## 1.2 Fichero de datos

Renombramos de forma manual Country y Country Code ya que no estan en 
el diccionario
```{r,results='hide', include=FALSE}

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>%
  rename(Country = `Country.Name`)

worldSustainabiltyDataSet<- worldSustainabiltyDataSet %>% 
  rename(CountryCode = `Country.Code`)

# Recorremos los nombres y sustitumos basandonos en los códigos
# de Dictionary

currColNames <- names(worldSustainabiltyDataSet)

updateCurrNames <- function(newColName, currColNames){
# Primero obtenemos los códigos en base al campo field
regimeField_Code <- data_dictionaryDataSet %>%
  filter(str_detect(Field,newColName)) %>%
  select(Code,Field)

# Ahora sustituimos por la nueva 
currColNames[grep(regimeField_Code$Code, currColNames)]<- newColName
  return (currColNames)
}

# Usamos la funcion 
currColNames <-  updateCurrNames('Regime', currColNames)

currColNames <- updateCurrNames('Income',currColNames)

currColNames <- updateCurrNames('Region', currColNames)

names(worldSustainabiltyDataSet) <- currColNames


```

```{r, echo=TRUE}
head(names(worldSustainabiltyDataSet),3)

```

# 2 Tipos de datos y Posibles Inconsistencias


## 2.1 Variables Cuantitativas

Comenzaremos comprobando los valores centinelas y los valores nulos o erroneos posibles.
```{r}
cleanNames <- names(worldSustainabiltyDataSet)
# Comenzamos solo por los null
worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="NULL", NA)
```

```{r, include=FALSE}

# Sustituimos por todas las variables

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="N/A", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="-", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="NA", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="9999", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="Unknown", NA)

names(worldSustainabiltyDataSet) <- cleanNames

```

## 2.2 Variables cuantitativas

### 2.2.1 Países y códigos de países
```{r, include=FALSE}
# definimos una función para hacer los cambios de formato
colDataFormatter<- function(colToFix){
  colToFix <- toupper(colToFix)
  colToFix <- str_replace_all(colToFix, " ", "_")
  return (colToFix)
}
```

```{r, include=FALSE}
countryCol <- worldSustainabiltyDataSet$Country
countryCodeCol <- worldSustainabiltyDataSet$CountryCode

# Agregamos los cambios al dataset:
countryCol <- colDataFormatter(countryCol)
countryCodeCol <- colDataFormatter(countryCodeCol)
worldSustainabiltyDataSet$Country <- countryCol
worldSustainabiltyDataSet$CountryCode <- countryCodeCol

```
Cambios aplicados: 
```{r}
head(unique(countryCol),4)
head(unique(countryCodeCol),4)
```

### 2.2.2 Continente

```{r, include=FALSE}
worldSustainabiltyDataSet$Continent <- colDataFormatter(worldSustainabiltyDataSet$Continent)
```
```{r}

head(unique(worldSustainabiltyDataSet$Continent))

```

### 2.2.3 Régimen
```{r, include=FALSE}

worldSustainabiltyDataSet$Regime <- colDataFormatter(worldSustainabiltyDataSet$Regime)
```
```{r}
head(unique(worldSustainabiltyDataSet$Regime))
```

### 2.2.4 Región
```{r, include=FALSE}

worldSustainabiltyDataSet$Region <- colDataFormatter(worldSustainabiltyDataSet$Region)
```
```{r}
head(unique(worldSustainabiltyDataSet$Region))
```

### 2.2.5 Región
```{r, include=FALSE}

worldSustainabiltyDataSet$Income <- colDataFormatter(worldSustainabiltyDataSet$Income)
```
```{r}
head(unique(worldSustainabiltyDataSet$Income))
```

# 3 Valores Extremos

## 3.1 Desigualdad (GINI)
```{r, include=FALSE}
  # Renombramos las columnas
  # Corresponde a la columna SI.POV.GINI
  worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( GINI = `Gini.index..World.Bank.estimate....SI.POV.GINI`)
  
  # Corresponde al codigo GH.EM.IC.LUF
  worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( GHE = `Annual.production.based.emissions.of.carbon.dioxide..CO2..measured.in.million.tonnes...GH.EM.IC.LUF`)
    

```

```{r}
# Creamos una tabla con las 3 columnas a trabajar
# Country GINI YEAR

tblCountryGiniYear <- worldSustainabiltyDataSet %>%
  select(Country, GINI,Year)
# Vistazo rápido de las columnas
summary(tblCountryGiniYear$Country)
summary(tblCountryGiniYear$GINI)
summary(tblCountryGiniYear$Year)
```

Comenzaremos con la realización de una boxplot para visualizar los datos de forma sencilla:

```{r}
boxplot(tblCountryGiniYear$GINI, main="GINI BOXPLOT")
boxplot(tblCountryGiniYear$Year, main="Year BOXPLOT")
# Comprobamos los stats para ver claramente los outliers
boxplot.stats(tblCountryGiniYear$GINI)$out

# Vamos a ver cuantos registr
length(tblCountryGiniYear$GINI)
length(which(is.na(tblCountryGiniYear$GINI)))
length(boxplot.stats(tblCountryGiniYear$GINI)$out)
```

Como podemos ver en el "boxplot" de GINI tenemos una gran cantidad de valores atípicos, 
existiendo una asímetría de datos positiva, puesto que tenemos bastantes valores outliers en GINI, esto conlleva cierta dispersión ya que tenemos valores alejados de la media y mediana.
Si nos centramos en los valores del "boxplot" de Year podemos observar como los mismos tienen cierta dispersión.

En cuanto a los valores outliers estos requieren una transformación puesto que aunque son pocos pueden distorsionar el estudio de valores esenciales como son la media/mediana, por lo que aplicamos winsorización: 

```{r}

tblCountryGiniYear$GINI <- psych::winsor(
  x = tblCountryGiniYear$GINI,
  trim = 0.01
)

boxplot(tblCountryGiniYear$GINI, main="Wisorized GINI")

```

## 3.2 Green House Emissions

### 1ª Parte 

Estudiaremos los valores outliers de forma similar al apartado 3.1: 

```{r}
boxplot(worldSustainabiltyDataSet$GHE, main="GHE Boxplot")
summary(worldSustainabiltyDataSet$GHE)
# Comparamos cuantos outliers hay sobre la población.
length(worldSustainabiltyDataSet$GHE)
length(boxplot.stats(worldSustainabiltyDataSet$GHE)$out)
```

Como podemos apreciar existe una gran cantidad de valores outliers dentro de los datos, pero en este caso no tiene sentido su transformación puesto que corresponde a aproximadamente el 16% del total de los mismos. En caso de realizar una transformación únicamente conseguiriamos alterar el resultado del estudio, al eliminar tantos resultados.

### 2ª Parte

Seleccionamos en una lista compuesta por los países más contaminantes en el año 2018, ordenandola de mayor a menor cantidad de emisiones.

```{r}
# Pillamos los valores de 2018
tblCountryGHE <- worldSustainabiltyDataSet %>%
  filter(Year == 2018) %>%
  select(Country, GHE)

# filtramos ahora por los valores outliers

tblCountryGHE <- tblCountryGHE %>%
  filter(GHE >= min(boxplot.stats(tblCountryGHE$GHE)$out) ) %>%
  arrange(desc(GHE))

head(tblCountryGHE)
```





















