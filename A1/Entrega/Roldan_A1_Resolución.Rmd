---
title: "A1"
author: "Antonio Roldán Andrade"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r, echo=FALSE,results='hide', include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(stringr)
library(skimr) 
library(ggplot2)
library(psych)
library(corrplot)
library(VIM)

```

## Disclaimer
Este es el documento de resolución de la actividad 1 para la asignatura de 
Análisis Estadístico.

# 1. Estructura de los datos

## 1.1 Diccionario de los datos
En este apartado simplemente realizamos la carga de datos y una pequeña ordenacion.
```{r, echo=TRUE}

# Cargamos en primer lugar el WorldSustainabilty
csv_location <- "WorldSustainabilityDataset.csv"
worldSustainabiltyDataSet <- read.csv(csv_location, sep = ",")

# Cargamos a continuación el DataDictonary
# Para cargar el dataset usamos la libreria readxl ==> install.packages("readxl")
# Realizamos la carga en la parte superior del código, limpieza

xlsx_location <- "Data_Dictionary.xlsx"
data_dictionaryDataSet <- read_excel(xlsx_location)


# Tabla 1 ==> ODS | Codigo Variable/Indicador | Descripcion

table1 <- data_dictionaryDataSet %>%
  select(`Associated SDG GOAL`, Code, Description)

# ODS | Descripcion
table2 <- data_dictionaryDataSet %>%
  select(`Associated SDG GOAL`, Description)

# Ordenamos y renombro por comodidad.
table1 <- table1 %>% arrange(`Associated SDG GOAL`)
table2 <- table2 %>% arrange(`Associated SDG GOAL`)

table1 <- table1 %>% rename( SDG = `Associated SDG GOAL`)
table2 <- table2 %>% rename( SDG = `Associated SDG GOAL`)
```
```{r}
head(table1,4)
head(table2,4)
```

## 1.2 Fichero de datos

Renombramos de forma manual Country y Country Code ya que no estan en 
el diccionario
```{r,results='hide'}

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>%
  rename(Country = `Country.Name`)

worldSustainabiltyDataSet<- worldSustainabiltyDataSet %>% 
  rename(CountryCode = `Country.Code`)

# Recorremos los nombres y sustitumos basandonos en los códigos
# de Dictionary

currColNames <- names(worldSustainabiltyDataSet)

updateCurrNames <- function(newColName, currColNames){
# Primero obtenemos los códigos en base al campo field
regimeField_Code <- data_dictionaryDataSet %>%
  filter(str_detect(Field,newColName)) %>%
  select(Code,Field)

# Ahora sustituimos por la nueva 
currColNames[grep(regimeField_Code$Code, currColNames)]<- newColName
  return (currColNames)
}

# Usamos la funcion 
currColNames <-  updateCurrNames('Regime', currColNames)

currColNames <- updateCurrNames('Income',currColNames)

currColNames <- updateCurrNames('Region', currColNames)

names(worldSustainabiltyDataSet) <- currColNames


```

```{r, echo=TRUE}
head(names(worldSustainabiltyDataSet),3)

```

# 2 Tipos de datos y Posibles Inconsistencias


## 2.1 Variables Cuantitativas

Comenzaremos comprobando los valores centinelas y los valores nulos o erroneos posibles.
```{r}
cleanNames <- names(worldSustainabiltyDataSet)
# Comenzamos solo por los null
worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="NULL", NA)
```

```{r}

# Sustituimos por todas las variables

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="N/A", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="-", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="NA", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="9999", NA)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% replace(.=="Unknown", NA)

names(worldSustainabiltyDataSet) <- cleanNames

```

## 2.2 Variables cuantitativas

### 2.2.1 Países y códigos de países
```{r}
# definimos una función para hacer los cambios de formato
colDataFormatter<- function(colToFix){
  colToFix <- toupper(colToFix)
  colToFix <- str_replace_all(colToFix, " ", "_")
  return (colToFix)
}
```

```{r}
countryCol <- worldSustainabiltyDataSet$Country
countryCodeCol <- worldSustainabiltyDataSet$CountryCode

# Agregamos los cambios al dataset:
countryCol <- colDataFormatter(countryCol)
countryCodeCol <- colDataFormatter(countryCodeCol)
worldSustainabiltyDataSet$Country <- countryCol
worldSustainabiltyDataSet$CountryCode <- countryCodeCol

```
Cambios aplicados: 
```{r}
head(unique(countryCol),4)
head(unique(countryCodeCol),4)
```

### 2.2.2 Continente

```{r}
worldSustainabiltyDataSet$Continent <- colDataFormatter(worldSustainabiltyDataSet$Continent)
```
```{r}

head(unique(worldSustainabiltyDataSet$Continent))

```

### 2.2.3 Régimen
```{r}

worldSustainabiltyDataSet$Regime <- colDataFormatter(worldSustainabiltyDataSet$Regime)
```
```{r}
head(unique(worldSustainabiltyDataSet$Regime))
```

### 2.2.4 Región
```{r}

worldSustainabiltyDataSet$Region <- colDataFormatter(worldSustainabiltyDataSet$Region)
```
```{r}
head(unique(worldSustainabiltyDataSet$Region))
```

### 2.2.5 Región
```{r}

worldSustainabiltyDataSet$Income <- colDataFormatter(worldSustainabiltyDataSet$Income)
```
```{r}
head(unique(worldSustainabiltyDataSet$Income))
```

# 3 Valores Extremos

## 3.1 Desigualdad (GINI)
```{r}
  # Renombramos las columnas
  # Corresponde a la columna SI.POV.GINI
  worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( GINI = `Gini.index..World.Bank.estimate....SI.POV.GINI`)
  
  # Corresponde al codigo GH.EM.IC.LUF
  worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( GHE = `Annual.production.based.emissions.of.carbon.dioxide..CO2..measured.in.million.tonnes...GH.EM.IC.LUF`)
    

```

```{r}
# Creamos una tabla con las 3 columnas a trabajar
# Country GINI YEAR

tblCountryGiniYear <- worldSustainabiltyDataSet %>%
  select(Country, GINI,Year)
# Vistazo rápido de las columnas
summary(tblCountryGiniYear$Country)
summary(tblCountryGiniYear$GINI)
summary(tblCountryGiniYear$Year)
```

Comenzaremos con la realización de una boxplot para visualizar los datos de forma sencilla:

```{r}
boxplot(tblCountryGiniYear$GINI, main="GINI BOXPLOT")
boxplot(tblCountryGiniYear$Year, main="Year BOXPLOT")
# Comprobamos los stats para ver claramente los outliers
boxplot.stats(tblCountryGiniYear$GINI)$out

# Vamos a ver cuantos registr
length(tblCountryGiniYear$GINI)
length(which(is.na(tblCountryGiniYear$GINI)))
length(boxplot.stats(tblCountryGiniYear$GINI)$out)
```

Como podemos ver en el "boxplot" de GINI tenemos una gran cantidad de valores atípicos, 
existiendo una asímetría de datos positiva, puesto que tenemos bastantes valores outliers en GINI, esto conlleva cierta dispersión ya que tenemos valores alejados de la media y mediana.
Si nos centramos en los valores del "boxplot" de Year podemos observar como los mismos tienen cierta dispersión.

En cuanto a los valores outliers estos requieren una transformación puesto que aunque son pocos pueden distorsionar el estudio de valores esenciales como son la media/mediana, por lo que aplicamos winsorización: 

```{r}

tblCountryGiniYear$GINI <- psych::winsor(
  x = tblCountryGiniYear$GINI,
  trim = 0.01
)

boxplot(tblCountryGiniYear$GINI, main="Wisorized GINI")

```

## 3.2 Green House Emissions

### 1ª Parte 

Estudiaremos los valores outliers de forma similar al apartado 3.1: 

```{r}
boxplot(worldSustainabiltyDataSet$GHE, main="GHE Boxplot")
summary(worldSustainabiltyDataSet$GHE)
# Comparamos cuantos outliers hay sobre la población.
length(worldSustainabiltyDataSet$GHE)
length(boxplot.stats(worldSustainabiltyDataSet$GHE)$out)
```

Como podemos apreciar existe una gran cantidad de valores outliers dentro de los datos, pero en este caso no tiene sentido su transformación puesto que corresponde a aproximadamente el 16% del total de los mismos. En caso de realizar una transformación únicamente conseguiriamos alterar el resultado del estudio, al eliminar tantos resultados.

### 2ª Parte

Seleccionamos en una lista compuesta por los países más contaminantes en el año 2018, ordenandola de mayor a menor cantidad de emisiones.

```{r}
# Pillamos los valores de 2018
tblCountryGHE <- worldSustainabiltyDataSet %>%
  filter(Year == 2018) %>%
  select(Country, GHE)

# filtramos ahora por los valores outliers

tblCountryGHE <- tblCountryGHE %>%
  filter(GHE >= min(boxplot.stats(tblCountryGHE$GHE)$out) ) %>%
  arrange(desc(GHE))

head(tblCountryGHE)
```


# 4 Correlaciones

```{r}
# Codigos implicados: 
# SP.DYN.LE00.IN ==> LE [48]
# SN_ITK_DEFC ==> DEFC [36]
# SP_ACS_BSRVH2O ==> BSRVW [40]
# SI_POV_DAY1 ==> POVL [37]
# SE.PRM.UNER.ZS ==> COSCH [13]
# NY.GDP.MKTP.CD ==> GDP [19]

# Renombramos y extraemos para mayor facilidad

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( LE = `Life.expectancy.at.birth..total..years....SP.DYN.LE00.IN`)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( DEFC = `Prevalence.of.undernourishment.......SN_ITK_DEFC`)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( BSRVW = `Proportion.of.population.using.basic.drinking.water.services.......SP_ACS_BSRVH2O`)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( POVL = `Proportion.of.population.below.international.poverty.line.......SI_POV_DAY1`)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( COSCH = `Children.out.of.school....of.primary.school.age....SE.PRM.UNER.ZS`)

worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>% rename( GDP = `GDP..current.US.....NY.GDP.MKTP.CD`)

colsToCorr <- c("LE", "DEFC", "BSRVW", "POVL", "COSCH", "GDP" )

dataToCorr <- worldSustainabiltyDataSet %>% select(all_of(colsToCorr))

head(dataToCorr)

corrMatrix <- cor(dataToCorr, 
                  use = "pairwise.complete.obs") #Ya que tiene elementos NA
corrMatrix <- round(corrMatrix,2) # Para tratar con 2 decimales

corrMatrix

# Usamos la libreria corrplot para mostrar de forma simplificada la matriz
corrplot(corrMatrix, 
         type = "upper", 
         order = "hclust",  
         tl.col = "black", 
         tl.srt = 45
         )

```

Por los resultados obtenidos existe cierta correlación, una correlación relativamente elevada puesto que la mayor correlación que existe es una correlación negativa entre las variables POVL (población viviendo bajo el umbral de la pobreza) y LE (Expectativa de Vida) y POVL con BSRVW (Población que usa fuentes básicas de agua), siendo la primera de -0.77 (POVL <-> LE) y -0.8 (POVL <-> BSRW).

Es decir, la esperanza de vida está fuertemente correlacionada con los indicadores sociales y de servicios básicos (Pobreza, Educación y Acceso al Agua) más que con el indicador económico crudo (PIB). Esto sugiere que la inversión en bienestar social y servicios esenciales es más efectiva para mejorar la salud de la población que el crecimiento económico general por sí solo.

# 5 Imputación

Con respecto a este apartado usaremos las medias de los vecinos más cercanos usando las variables con una mayor correlación, es decir, mediante las conclusiones obtenidas en el apartado anterior tenemos que las variables a utilizar serán: BSRVW, POVL y COSCH puesto que son aquellas con una correlación lo suficientemente alta.

```{r}
# Comprobamos que columnas estan vacías para aplicarle la imputación
tblNAYear <- worldSustainabiltyDataSet %>%
  group_by(Year) %>%
  filter(all(is.na(LE)) == TRUE) %>%
  select(Year) %>%
  ungroup()

unique(tblNAYear$Year)

# Creamos una tabla con los LE del año 2001 ya que no puede tener NA a la hora de hacer kNN
datoskNNImputados <- worldSustainabiltyDataSet %>% filter(Year == 2001) %>% 
  select(LE, BSRVW, POVL, COSCH )

# 2. Aplicar kNN. Imputamos LE (variable)
datoskNNClean <- kNN(
  data = datoskNNImputados,
  variable = c("LE"),
  k = 5,
  dist_var = c("BSRVW", "POVL", "COSCH")
)
#Aqui tenemos los datos de KNN con datos ya imputados
head(datoskNNClean$LE)

# Preparamos la sustitución agregando una columna 
worldSustainabiltyDataSet$LE2000 <- datoskNNClean$LE

# Hacemos un mutate para sustituir los valores del año 2000 por los valores guardados en LE2000
worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>%
  mutate(
    LE = case_when(
      # Condición: Si el año es 2000, usa el valor imputado
      Year == 2000 ~ LE2000,
      # Si el año no es 2000, mantén el valor original de la columna LE
      TRUE ~ LE
    )
  ) %>%
  select(-LE2000) # Eliminar la columna auxiliar



```

# 6 Tabla resumen


```{r}
# Variables relacionadas:
# SI_POV_DAY1 --> POVL
# GINI
# LE 

# Se pide calcular las medidas de tendencia central y dispersión (robustas y no robustas)



# Datos: Agrupamos los datos por regiones, mostramos solo los datos más recientes.

# Comenzamos agrupando los distintos datos:

recentData <- worldSustainabiltyDataSet %>% 
  group_by(Region) %>%
  filter(Year == max(Year, na.rm = TRUE)) %>%
  select(POVL, GINI, LE, Region)


# Realizamos los cálculos al mismo tiempo y después separamos en tablas
recentData <- recentData %>%
  summarise(
    # Aplicar las cuatro funciones a las variables definidas
    across(
      .cols = all_of(c('LE', 'GINI', 'POVL')), 
      .fns = list(
        # TB1: Tendencia Central
        Media = ~ mean(.x, na.rm = TRUE), # No Robusta
        Mediana = ~ median(.x, na.rm = TRUE), # Robusta
        
        # Dispersión
        Desviacion_Estandar = ~ sd(.x, na.rm = TRUE), # No Robusta
        Desviacion_Absoluta_Mediana = ~ mad(.x, na.rm = TRUE) # Robusta
      ),
      .names = "{.col}_{.fn}" #  columnas dinámicas ('LE_Media', 'GINI_Mediana',... )
    ),
    .groups = 'drop' # No requerimos hacer agrupaciones tras realizar el cálculo.
  )

# Tabla 1 : Medidas de tendencia Central (media, mediana)

centralTendencyTable <- recentData %>% 
  select(
    Region,
    ends_with("Media"),
    ends_with("Mediana")
  )

print(centralTendencyTable)

# Tabla 2 : Medias de dispersión (desviación estandar, desviación absoluta con respecto a la mediana)

dispersionTable <- recentData %>% 
  select(
    Region, 
    ends_with("Desviacion_Estandar"), 
    ends_with("Desviacion_Absoluta_Mediana")
  )

print(dispersionTable)

# Como fin de práctica guardamos los cambios realizados en el csv
write.csv(worldSustainabiltyDataSet, csv_location)

```















