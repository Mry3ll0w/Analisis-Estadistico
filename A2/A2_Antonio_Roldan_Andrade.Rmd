---
title: "A2_Antonio_Rolda_Andrade"
author: "Antonio Roldán Andrade"
date: "2025-11-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Imports necesarios de cara al trabajo a realizar
library(readxl)
library(dplyr)
library(ggplot2)
```

# 1 Esperanza de Vida

## 1.1 Análisis Descriptivo

Previo al estudio del caso realizo las transformaciones de las columnas para 
mejor legibilidad.

```{r}
# Antes de comenzar abrimos el dataset 
xlsx_location <- "WorldSustainabilityDS_clean.xlsx"
worldSustainabiltyDataSet <- read_excel(xlsx_location)

# Pasamos ahora a renombrar SP.DYN.LE00.IN
worldSustainabiltyDataSet <- worldSustainabiltyDataSet %>%
  rename(LE = `SP.DYN.LE00.IN`)
# Extraemos las columnas necesarias {LE,Income, Region}

dtLEInReg <- worldSustainabiltyDataSet %>% select(LE, Income,Region)

# Grafico comparando Esperanza de vida y nivel de ingresos

grafico1_1 <- ggplot(
  data = dtLEInReg,
  mapping = aes(x = Income, y = LE, fill = Income) # Con fill mostramos por color cada grupo de Income
) +
  geom_boxplot() +
  geom_jitter(
    color = "yellow",
    size = 0.5,
    alpha = 0.5, # Transparencia para evitar superposición
    width = 0.2  # Pequeño desplazamiento horizontal para los puntos
  ) +
  labs(
    title = "Esperanza de Vida (LE) por Nivel de Ingresos",
    x = "Nivel de Ingresos",
    y = "Esperanza de Vida al nacer (Años)",
    fill = "Nivel de Ingresos"
  )
# Mostrar el gráfico
print(grafico1_1)
names(worldSustainabiltyDataSet)

```

## 1.2 Hipótesis
- La pregunta a contrastar es: ¿La esperanza de vida es mayor en los países con alto nivel de ingresos que en el resto?

- Los datos a usar son los pertenencientes a países con ingresos altos (High Income) del 
último año de los datos (2018)

Por tanto, podemos plantear las siguientes hipótesis:
  
  - u1 -> LE High Income
  - u2 -> LE Resto
  - H0: u1 = u2
  - H1: u1 > u2

Realizaremos un test unilateral derecho para verificar la hipótesis nula.

## 1.3 Test

Estamos en un caso en el que se tiene una muestra de datos grandes por lo que se puede 
asumir que la distribución sigue una distribución normal, puesto que la población es 
mayor que 30. Además tratamos de un contraste de hipótesis de dos poblaciones (High Income y el resto) independientes sin covarianza conocida.

```{r}
# Realizamos un filtrado extrayendo los datos que necesitamos

# LE de altos ingresos
dt1_3 <- worldSustainabiltyDataSet %>%
  filter(Year == 2018)

# Preparamos la columnas como True o false en caso de High Income o no
dt1_3 <- dt1_3 %>%
  filter(!is.na(LE)) %>% # No usamos las columnas con NA
  # 2. Guardamos el resultado de mutate en IncomeGroup
  mutate(
    IncomeGroup = case_when(
      # Si el ingreso es 'High income', asigna 'Alto Ingreso'
      Income == "High income" ~ "Alto Ingreso",
      # Para cualquier otro caso (el resto de ingresos), asigna 'Resto de Ingresos'
      TRUE ~ "Resto Ingresos"
    )
  )

# Realizamos antes de asumir nada sobre las varianzas si estas son iguales 
alpha <- 1 - 0.95
m1 <- mean(dt1_3$LE[dt1_3$IncomeGroup == 'Alto Ingreso'])
m2 <- mean(dt1_3$LE[dt1_3$IncomeGroup == 'Resto Ingresos'])
n1 <- length(dt1_3$LE[dt1_3$IncomeGroup == 'Alto Ingreso'])
n2 <- length(dt1_3$LE[dt1_3$IncomeGroup == 'Resto Ingresos'])
s1 <- sd(dt1_3$LE[dt1_3$IncomeGroup == 'Alto Ingreso'])
s2 <- sd(dt1_3$LE[dt1_3$IncomeGroup == 'Resto Ingresos'])
fobs <- (s1*s1)/(s2*s2)

fcritL <- qf(alpha/2, df1 = n1-1, df2= n2-1)
fcritU <- qf(1 - alpha/2, df1 = n1-1, df2= n2-1)

# Calculamos el pvalue
pvalue <- min(
  pf(fobs, df1=n1-1, df2=n2-2, lower.tail = FALSE),
  pf(fobs, df1=n1-1, df2=n2-2)
)

c(fobs, fcritL, fcritU, pvalue)

```

Como podemos apreciar se rechaza la hipótesis nula, tanto por caer fuera del intervalo
de confianza como por el valor de pvalue. Por tanto, las covarianzas son distintas.

## 1.4 Aplicación del Test Estadístico

```{r}
# Aplicamos t student

t.test(dt1_3$LE[dt1_3$IncomeGroup == 'Alto Ingreso'], dt1_3$LE[dt1_3$IncomeGroup == 'Resto Ingresos'], alternative="greater", var.equal=FALSE)

```

## 1.5 Desarrollo

Dada la situación en la que nos encontramos (covarianza desconocida, poblaciones distintas y no dependientes) tendremos que realizar
los siguientes cálculos:

```{r}
# Calculamos el test T de Welch

tWelch <- (m1 - m2) / sqrt( (s1^2/n1) + ( s2^2/n2 ) )

# Calculamos los grados de libertad df

df_num <- ( ( s1^2/n1 ) + (s2^2/n2) )^2
df_den <- ( (s1^2/n1)^2 / (n1-1) ) + ( (s2^2/n2)^2 / (n2-1) ) 
df <- df_num / df_den
# Calculamos el pvalue ==> Queremos comprobar que sea mayor, por lo que unilateral derecho
# Reuso la variable
pvalue <- pt(tWelch, df=df, lower.tail = FALSE)


```

## 1.6 Resultados

```{r, echo=FALSE}
cat("--- Resultados de la Prueba T de Welch (Implementación Propia) ---\n")
cat(sprintf("Media (µ1) Alto Ingreso: %.4f\n", m1))
cat(sprintf("Media (µ2) Resto Ingresos: %.4f\n", m2))
cat(sprintf("Valor Observado (Estadístico t): %.3f\n", tWelch))
cat(sprintf("Grados de Libertad (df): %.2f\n", df))
print("Valor p (unilateral, H1: µ1 > µ2):")
print(pvalue)

```

## 1.7 Interpretación

Como podemos apreciar el valor calculado es muy similar al obtenido al usar la función que nos proporciona el entorno de R, 
por lo que podemos decir con una fiabilidad del 95 % que la hipotesis nula no se cumple, por lo que la hipotesis alternativa
será tomada como correcta, por tanto, podemos afirmar que la esperanza de vida en países con alto ingresos es superior a la 
de países con menores ingresos.



# 2 Desigualdad a lo largo del tiempo

**PR2:  ¿La desigualdad se reduce en un período de 10 años? **

```{r}
# Preparamos los datos: 
# Usamos la columna SI.POV.GINI ==> renombramos a GINI
# Rango de tiempo ==> 2008 a 2018
# Población 1: Todos los países del mundo.
# Población 2: Países de cuya región == “Europe and Northern America”

dt2 <- worldSustainabiltyDataSet %>% rename( GINI = SI.POV.GINI )

dt2 <- dt2 %>% filter( (Year >= 2008 ) & (Year <=2018 ) )

#Filtramos y preordenados
dt2EuNorthern <- dt2 %>% 
  filter(Region == "Europe and Northern America") %>%
  arrange(desc(GINI))

dt2 <- dt2 %>% arrange(desc(GINI)) # Ordenamos todos los paises
```

## 2.1 Análisis Descriptivo

```{r}
# Gráfico comparativo
dt2 %>%
  filter(!is.na(GINI)) %>%
  mutate(Year = as.factor(Year)) %>% # Para que sirva para el gráfico.
  ggplot(aes(x = Year, y = GINI, fill = Year)) +
  geom_boxplot() + # Solo la caja y bigotes
  labs(
    title = "Desigualdad Global (GINI): 2008 vs 2018",
    x = "Año",
    y = "Índice GINI"
  ) 

dt2EuNorthern %>%
  filter(!is.na(GINI)) %>%
  mutate(Year = as.factor(Year)) %>% # Para que sirva para el gráfico.
  ggplot(aes(x = Year, y = GINI, fill = Year)) +
  geom_boxplot() + # Solo la caja y bigotes
  labs(
    title = "Desigualdad EU y America del Norte (GINI): 2008 vs 2018",
    x = "Año",
    y = "Índice GINI"
  )

# 1. PAÍSES CON MAYOR DESIGUALDAD (GINI más alto)

tbMayorDesigualdadGlobal <- dt2 %>% 
  filter(!is.na(GINI)) %>% 
  arrange(desc(GINI)) %>% 
  head(5) %>%             
  select(GINI, Country, Region, Year)

tbMayorDesigualdadGlobal

tbMayorDesigualdadEuNA <- dt2EuNorthern %>% 
  filter(!is.na(GINI)) %>% 
  arrange(GINI) %>% 
  head(5) %>%        
  select(GINI, Country, Region, Year)

tbMayorDesigualdadEuNA

# 2. PAÍSES CON MENOR DESIGUALDAD (GINI más bajo)

tbMenorDesigualdadEuNA <- dt2EuNorthern %>% 
  filter(!is.na(GINI)) %>% 
  arrange(GINI) %>% 
  tail(5) %>%        
  select(GINI, Country, Region, Year)

tbMenorDesigualdadEuNA

tbMenorDesigualdadGlobal <- dt2 %>% 
  filter(!is.na(GINI)) %>% 
  arrange(GINI) %>% 
  tail(5) %>%        
  select(GINI, Country, Region, Year)

tbMenorDesigualdadGlobal
```

## 2.2 Hipótesis

Siendo la pregunta de investigación:  ¿La desigualdad se reduce en un período de 10 años?
podemos plantear las siguentes hipótesis:

- n1: Población del año 2008, g1 (GINI de 2008)
- n2: Población del año 2018, g2 (GINI 2018)
- Hipótesis Nula (h0): g1 = g2
- Hipótesis Alternativa (h1): g1 > g2


## 2.3 Test

No podemos tratar a esta población como muestras dependientes, puesto que no estamos 
relacionandos los mismos paises entre si, es decir, España 2008 con España 2018.
Además no tenemos una covarianza puesto que no tratamos a la variable "Año" como algo
numérico si no de forma categórica.  
Por tanto, tenemos un caso de contraste de hipótesis de dos poblaciones independientes 
con una covarianza desconocidas, por lo que usaremos el t de Welch.

## 2.5 Aplicación del Test

```{r}
# Filtramos p
dt2 <- dt2 %>% filter(!(is.na(GINI)))
dt2_2008 <- dt2 %>% filter(Year == 2008)
dt2_2018 <- dt2 %>% filter(Year == 2018)

# Comprovamos igualdad de varianzas
# Realizamos antes de asumir nada sobre las varianzas si estas son iguales 
alpha <- 1 - 0.95
m1 <- mean(dt2_2008$GINI)
m2 <- mean(dt2_2018$GINI)
n1 <- length(dt2_2008$GINI)
n2 <- length(dt2_2018$GINI)
s1 <- sd(dt2_2008$GINI)
s2 <- sd(dt2_2018$GINI)
fobs <- (s1*s1)/(s2*s2)

fcritL <- qf(alpha/2, df1 = n1-1, df2= n2-1)
fcritU <- qf(1 - alpha/2, df1 = n1-1, df2= n2-1)

# Calculamos el pvalue
pvalue <- min(
  pf(fobs, df1=n1-1, df2=n2-1, lower.tail = FALSE),
  pf(fobs, df1=n1-1, df2=n2-1)
)

c(fobs, fcritL, fcritU, pvalue)




```
Como podemos ver en los valores mostrados, las covarianzas son iguales (h0), ya que 
se encuentra el valor observado dentro del intervalo de confianza, además el pvalue es mayor que alfa, reforzando así la hipótesis nula.

```{r}
# Haremos un test de Welch para covarianzas iguales
t.test(dt2_2008$GINI, dt2_2018$GINI, alternative="greater", var.equal=TRUE)

```

## 2.5 Desarrollo 



















